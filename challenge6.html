/*
    WEEK 6 - CHALLENGE YOURSELF
    controllers > customerController.js
*/

const Cust = require('../models/customerModel');

const createCustomer = async (req, res, next) => {
    try {
        const {name, email, phone, isActive} = req.body;
        if(!name || !email || !phone) 
            return res.status(404).json({message: "Name, email, and phone are required"});
        const c = new Cust({name, email, phone, isActive});
        const s = await c.save();
        res.status(201).json(s);
    } catch(err) { next(err); }
};

const getAllCustomers = async (req, res, next) => {
    try { 
        res.status(200).json(await Cust.find()); 
    } catch(err) { next(err); }
};

const updateCustomer = async (req, res, next) => {
    try {
        const u = await Cust.findByIdAndUpdate(req.params.id, req.body, {new: true});
        if(!req.body.name || !req.body.email || !req.body.phone)
            return res.status(404).json({message: "Name, email, and phone are required to update the customer"});
        if(!u) return res.status(404).json({message: "Customer not found"});
        res.status(200).json(u);
    } catch(err) { next(err); }
};

module.exports = {createCustomer, getAllCustomers, updateCustomer};
/*
    WEEK 6 - CHALLENGE YOURSELF
    middlewares > errorHandler.js
*/

const eh = (err, req, res, next) => {
    console.error(err.message);
    res.status(500).json({message: "Server Error"});
};

module.exports = eh;
/*
    WEEK 6 - CHALLENGE YOURSELF
    models > customerModel.js
*/

const mg = require("mongoose");

const cs = new mg.Schema({
    name: {
        type: String,
        required: true,
    },
    email: {
        type: String,
        required: true,
    },
    phone: {
        type: String,
        required: true,
    },
    isActive: {
        type: Boolean,
        default: true
    }
});

module.exports = mg.model("Customer", cs);
/*
    WEEK 6 - CHALLENGE YOURSELF
    routers > customerRoutes.js
*/

const ex = require('express');
const {cc, gc, uc} = require("../controllers/customerController");
const r = ex.Router();

r.post('/customers', cc);
r.get('/customers', gc);
r.put('/customer/:id', uc);

module.exports = r;
/*
    WEEK 6 - CHALLENGE YOURSELF
    index.js
*/

const ex = require('express');
const mg = require('mongoose');
const r = require('./routers/customerRoutes');
const eh = require('./middlewares/errorHandler');

const app = ex();
app.use(ex.json());

mg.connect("mongodb://127.0.0.1:27017/customerDB")
    .then(() => console.log("DB connected"))
    .catch(err => console.error(err));

app.use('/api', r);
app.use(eh);

app.listen(8080, () => console.log("Server running on 8080"));

